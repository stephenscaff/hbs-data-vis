{{debug}}
{{#cityQuery cities}}
<section class="city-cards">
  <div class="grid-med">

    <!-- City Cards Grid -->
    <div class="city-cards__grid">

      <!-- City Cards Col -->
      <div class="city-cards__col">

      <!-- City Card -->
      <section class="city-card city-card--half city-card--info ">

        <!-- Header : Map -->
        <header class="city-card__header">
          <div class="city-card__map-wrap">
            <div id="js-map" class="js-map city-card__map">
              <span class="city">{{cityFormat city}}</span>
              <span class="state">{{country}}</span>
              <span class="country">{{continentFormat continent}}</span>
            </div>
          </div>
        </header>

        <div class="city-card__content">
          <!-- Badge -->
          {{#if mega_city}}
            <img class="city-card__badge" src="http://inrix.com/wp-content/themes/inrix/assets/images/scorecards/badges/mega-city.png"/>
          {{else}}
            {{#if major_city}}
            <img class="city-card__badge" src="http://inrix.com/wp-content/themes/inrix/assets/images/scorecards/badges/major-city.png"/>
            {{/if}}
          {{/if}}
          <!-- Rank -->
          <span class="city-card__rank">{{getOrdinal all_rank_2016}}</span>
          <!-- Title / City -->
          <h2 class="city-card__cityname">{{cityFormat city}}</h2>
          <!-- Flag -->
          <img class="city-card__flag" src="assets/images/flags/{{fileName country}}.png"/>
          <!-- Region, Country -->
          <span class="city-card__country">{{country}}, {{continentFormat continent}}</span>
        </div>
        <footer class="city-card__footer">
          <!-- Stats -->
          <ul class="city-card__stats">
            <li>
              <span class="city-card__numb">{{getOrdinal rank_country}}</span>
              <span class="city-card__desc">Out of {{total_country}} cities in {{#if the}}the{{/if}} {{country}}</span>
            </li>
            <li>
              <span class="city-card__numb"><span>{{getOrdinal rank_continent}}</span></span>
              <span class="city-card__desc">Out of {{total_continent}} cities in {{continent}}</span>
            </li>
            <li>
              <span class="city-card__numb"><span>{{getOrdinal all_rank_2016}}</span></span>
              <span class="city-card__desc">Out of 1,064 cities in the world</span>
            </li>
          </ul>
        </footer>
      </section>
    </div>

    <!-- City Cards Col -->
    <div class="city-cards__col">

      <!-- City Card: Congestion -->
      <section class="city-card city-card--half city-card--congestion">
        <div class="city-card__content">

          <!-- Congestion Chart: Time Spent -->
          <div class="city-card__chart">
            <!-- Chart Wrap -->
            <div class="city-card__chart-pie">
              <div class="city-card__chart-wrap">
                <canvas id="js-congestion-time-spent" class="city-card__render"></canvas>
              </div>
            </div>
            <!-- Figures -->
            <div class="city-card__chart-figures">
              <span class="city-card__numb">{{overall}}</span>
              <span class="city-card__desc">Driving time spent in congestion in 2016</span>
            </div>
          </div>

          <!-- Congestion Chart: Peak Hours -->
          <div class="city-card__chart">
            <!-- Chart Wrap -->
            <div class="city-card__chart-pie">
              <div class="city-card__chart-wrap">
                <canvas id="js-congestion-peak" class="city-card__render"></canvas>
              </div>
            </div>
            <!-- Figures -->
            <div class="city-card__chart-figures">
              <span class="city-card__numb">{{hours_in_congestion}}</span>
              <span class="city-card__desc">Peak hours spent in congestion in 2016</span>
            </div>
          </div>

          <!-- Congestion Chart: Index -->
          <div class="city-card__chart">
            <!-- Chart Wrap -->
            <div class="city-card__chart-pie">
              <div class="city-card__chart-wrap">
                <canvas id="js-congestion-index" class="city-card__render"></canvas>
              </div>
            </div>
            <!-- Figures -->
            <div class="city-card__chart-figures">
              <span class="city-card__numb">{{ici}} ICI</span>
              <span class="city-card__desc">INRIX Congestion Index</span>
            </div>
          </div>
        </div>
      </section>

      </div>
    </div>

    <!-- City Card: Time Spent in Congestion -->
    <section class="city-card city-card--bar city-card--full">
      <div class="city-card__content">
        <header class="city-card__header"><h4 class="city-card__chart-title">Driving Time Spent in Congestion</h4></header>
        <div class="city-card__bar">
          <canvas id="js-congestion-bar" class="city-card__render"></canvas>
        </div>
      </div>
    </section>

    <!-- Legend for Congestion -->
    <section class="city-card legend-card">
      <div class="city-card__content">
      <header class="legend-card__header">
        <h4 class="legend-card__heading">Legend</h4>
      </header>
        <div class="legend-card__wrap">
        <div class="legend-card__col">

        <article class="legend-card__item">
          <h5 class="legend-card__title">Peak In/Out</h5>
          <p class="legend-card__text">This is the percentage of driving time spent in congestion, on average, during peak hours on roads into and out of the city.</p>
        </article>

        <article class="legend-card__item">
          <h5 class="legend-card__title">Peak Within</h5>
          <p class="legend-card__text">This is the percentage of driving time spent in congestion, on average, during peak hours on roads within the city.</p>
        </article>

        <article class="legend-card__item">
          <h5 class="legend-card__title">Day In/Out</h5>
          <p class="legend-card__text">This is the percentage of driving time spent in congestion, on average, at noon on roads into and out of the city.</p>
        </article>

        <article class="legend-card__item">
          <h5 class="legend-card__title">Day Within</h5>
          <p class="legend-card__text">This is the percentage of driving time spent in congestion, on average, at noon on roads within the city.</p>
        </article>

        </div>

        <div class="city-card__col">
          <article class="legend-card__item">
          <h5 class="legend-card__title">Late In/Out</h5>
          <p class="legend-card__text">This is the percentage of driving time spent in congestion, on average, at late night on roads into and out of the city.</p>
        </article>

        <article class="legend-card__item">
          <h5 class="legend-card__title">Late Within</h5>
          <p class="legend-card__text">This is the percentage of driving time spent in congestion, on average, at late night on roads within the city.</p>
        </article>

        <article class="legend-card__item">
          <h5 class="legend-card__title">Weekend</h5>
          <p class="legend-card__text">This is the percentage of driving time spent in congestion, on average, on all roads at the weekend.</p>
        </article>
        </div>
      </div>
      </div>
    </section>
  </div>
</section>

</main>

<script type="text/javascript">
/**
 * Global Font
 */
Chart.defaults.global.defaultFontFamily = 'franklin';

/**
 * Pie Charts : Congestion
 */
var congenstionTimeSpent = document.getElementById('js-congestion-time-spent');
var congenstionPeak = document.getElementById('js-congestion-peak');
var congenstionIndex = document.getElementById('js-congestion-index');

/**
 * Pie Chart Globals
 */
var pieCutoutPercentage = '75';
var pieBackgroundColor = ['#f1c400', '#005eb8'];
var pieHoverBackgroundColor = ['#f1c400', '#005eb8'];
/**
 * Pie: Congestion Percent Spent
 */
var congenstionTimeSpentPie = new Chart(congenstionTimeSpent, {
  type: 'pie',
  data: {
    datasets: [{
      data: ["{{trimPercent overall}}", 100 - "{{trimPercent overall}}"],
      backgroundColor: pieBackgroundColor,
      hoverBackgroundColor: pieHoverBackgroundColor,
    }]
  },
  options: {
    cutoutPercentage: pieCutoutPercentage,
    responsive: true,
    tooltips : {
        enabled: false
    },
    elements: {
      arc: {
        borderWidth: 0
      }
    }
  }
});

/**
 * Pie: Congestion Hours Specnt
 */
var congenstionPeakPie = new Chart(congenstionPeak, {
  type: 'pie',

  data: {
    datasets: [{
      data: ["{{hours_in_congestion}}", 105 - "{{hours_in_congestion}}"],
      labels: ['Hours In Traffic', 'Total Hours'],
      backgroundColor: pieBackgroundColor,
      hoverBackgroundColor: pieHoverBackgroundColor,
    }]
  },

  options: {
    cutoutPercentage: pieCutoutPercentage,
    responsive: true,
    tooltips : {
      enabled: false
    },
    elements: {
      arc: {
        borderWidth: 0
      }
    }
  }
});

/**
 * Pie: Congestion ICI
 */
var congenstionIndexPie = new Chart(congenstionIndex, {
  type: 'pie',
  data: {
    datasets: [{
      data: ["{{ici}}", 20 - "{{ici}}"],
      backgroundColor: pieBackgroundColor,
      hoverBackgroundColor: pieHoverBackgroundColor,
    }]
  },
  options: {
    cutoutPercentage: pieCutoutPercentage,
    responsive: true,
    tooltips : {
        enabled: false
    },
    elements: {
      arc: {
        borderWidth: 0
      }
    }
  }
});


/**
 *  Bar Chart : Congestion
 */
var barChart = document.getElementById('js-congestion-bar');
var data = {
  labels: ['Peak In/Out', 'Peak Within', 'Day In/Out', 'Day Within', 'Late In/Out', 'Late Within', 'Weekend'],
  datasets: [
    {
      backgroundColor: '#dddddd',
      hoverBackgroundColor: '#f1c400',
      data: ["{{trimPercent peak_in_out}}", "{{trimPercent peak_within}}", "{{trimPercent day_in_out}}", "{{trimPercent day_within}}", "{{trimPercent late_in_out}}", "{{trimPercent late_within}}", "{{trimPercent weekend}}"]
    }
  ]
};

/**
 * Custom Tooltip
 */
Chart.defaults.global.tooltipTemplate =
  "<%if (label){%><%=label%>: <%}%><%= value %> %";
var congestionBarChart = new Chart(barChart, {
  type: 'bar',
  data: data,
  options: {
    title: {
      display: false,
      fontSize: 24,
      fontStyle: 'normal',
      text: 'Driving Time Spent in Congestion',
    },
    legend: {
      display: false
    },
    responsive: true,
    scales: {
      xAxes: [{
        gridLines: {
          display: false
        }
      }],
      yAxes: [{
        scaleLabel: {
          display: true,
          labelString: 'Percentage',
          fontSize: 15,
        },
        ticks: {
          beginAtZero: true
        },
      }]
    },
    tooltips: {
      callbacks: {
        label: function(tooltipItems, data) {
          return tooltipItems.yLabel + '%';
        }
      }
    }
  }
});


/**
 * City Map
 */
var CityMap = (function() {
  var s;
  var icon = {
    url: 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFIAAABsCAYAAAD5XOVGAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAABClJREFUeNrsndFt2zAQhmkh79YGzgbxAAWivBeoN3AyQdQJ6m6gbiBPUAfIe2Ug77UniDRBrQlSsj2jRtAEong8Huk7gECCyJb56T/yjjw6k5eXFyXmbpkgEJACUkCKCUgBKSAFpJiAFJACUuyvXbi+wYfiI9ZnuYRW6JbrNn/juhbaDlrrctOn5pEHSEdbQDPwZgNfc/3q9063RrcNtDgVOVJ5pW63uk0R3s88gCW0HmBWoNYkx0gDsNbtWbd7JIivbQpAf4JKi5RA5qCQZ+gklZkh4Ac8vDx2kAW42H3AcXgJE9IiVpAVKGKmwptx+e8+1Zl5cuUmsArfU2fjA2bmCeI149j5Cj7jJVeQR4hXESQiVzB259xAxgTxdNxsdGaWcwJZRQbxVJkbLiBL4vgQPd7Uqqxc32TiUiCgP8AcsogU7OapeWxCKbJS6VgdxLW1Gm+ZhznWix+6T6sQilyp9KwcO4tnDmqcJQhyCpMnmSJTVKOTKrMRalwkqsZTVS4oFLlQ6VspIJEyHu15l95AgltP1XlY4VORhTofs+qr7S7inLgzZqu1hZ9zRbsw4lWRVCD3JvdV/woGCrj3DfyNJNPxAhJiqykRRAPufwsIDQBdU5DUfS58KJJCjT1APAwITzpOAyq3IqpqAEQF11BkV/NYQTYW11LU+eTnAPIgro0zDucCEid2Kzh5iA1IijK50tO1fBT51DxSjEkmCK4HXGdmbO/bHDabYbauvSWAuYQZOX9jXDQh0hei9NRbrr1TNBten3T7BRnMMdc26SLl6tPON0hKC1l4YNVXW9du1PmYVV+tKy10It+qtPds/uT8eqLJfSryXFRp3ccxIDdnAHLjHaSWvLlJL4rESRFTVuVei6UVkO42qsJuFMjE3XtDBhKsThDieuyaQkbtAsxttDhGg4QBeZsQxE5Kn3Fs5fLiieu39SWSMlqnhNiKdH6SMYc82CDNAN3FrEYuIGNXZYWxjYIFMlZVoqgRE2Ssqlxhbephgqwjiys7zPANu0AgJlWi7otjgzSZwToCiFuFvIKVeXrS3FeGbrHf0AfIA3MX/6ocv0+NCuQxU+A48XS+HnLm2X361F2aAmTLzMW/KY9byb7rI7m4+N73Q82I3Kln4NKH2EG2PsemAfZZERR/UZU+bwIF6g+KaBU/I3avPeH9OkpPoC7GXxCNlz3c65AqyFbRHJwvVcLfsXu0BiYAn/FiTd2pUOdsKk+Tz4MKdGwk5IEl7MlnHzLMCn3yq0CCOfR4crIgDwgzeXCIHEAeZ/JiJMwjxF3oTnA51LkbCbPkAJETyFOYQ+1OMarR5HbMeAeAooLIEaQCQHcxQeQK8j2YLCFyBnkKs+cO0diF4m01jJtzxbz4fyL/Xzt91xaQAlJMQApIASkmIAWkgBSQYgKS1H4LMADuPv4w1aVnhQAAAABJRU5ErkJggg==', // url
    scaledSize: new google.maps.Size(30, 41), // scaled size
    origin: new google.maps.Point(0,0), // origin
    anchor: new google.maps.Point(0, 0) // anchor
  };

  /**
   * Settings
   */
  var settings = {
    cityMapRender: $('.js-map'),
    cityMarker: $('.marker'),
    self: null
  };

  return {
    /**
     * Init
     */
    init: function() {
      s = settings;
      this.renderMap();
    },

    /**
     * RednerMap
     */
    renderMap: function(){

      var styles = [{"stylers":[{"hue":"#2c3e50"},{"saturation":250}]},{"featureType":"road","elementType":"geometry","stylers":[{"lightness":50},{"visibility":"simplified"}]},{"featureType":"road","elementType":"labels","stylers":[{"visibility":"off"}]}];

      // Map Args
      var args = {
        zoom: 6,
        center: new google.maps.LatLng(0, 0),
        mapTypeId: google.maps.MapTypeId.ROADMAP,
        styles: styles,
        scrollwheel: false,
        disableDefaultUI: false,
        mapTypeControl: false,
      };

      /**
       *  Parse Address markup to create map location
       */
      s.cityMapRender.each(function(index, Element) {

        $el = $(Element);

        //Map vars
        var map;
        var geocoder;
        var marker;
        var address =
        $el.children('.city').text() + ', ' +
        $el.children('.state').text() + ' ' +
        $el.children('.country').text();

        // New Google Geocoder
        geocoder = new google.maps.Geocoder();

        // Geocode that Address son
        geocoder.geocode({ 'address': address },

        function(results, status) {

          // Status check
          if (status === google.maps.GeocoderStatus.OK) {

            args.center = results[0].geometry.location;

            map = new google.maps.Map(Element, args);

            // Center on resize
            CityMap.centerMapResize(map);

            //Marker customizations
            marker = new google.maps.Marker({
              map: map,
              position: results[0].geometry.location,
              animation: google.maps.Animation.DROP,
              icon: 'http://inrix.com/wp-content/themes/inrix/assets/images/scorecards/gps-marker.png',
            });
          }
        });
      });
    },

    /**
     * Center Map on Resize
     */
    centerMapResize: function(map){
      google.maps.event.addDomListener(window, "resize", function() {
        var center = map.getCenter();
        google.maps.event.trigger(map, "resize");
        map.setCenter(center);
      });
    },
  };
})();

CityMap.init();
</script>

{{/cityQuery}}
